rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin (authenticated user)
    function isAdmin() {
      return isAuthenticated();
    }
    
    // Products collection
    match /products/{productId} {
      // Anyone can read products (public)
      allow read: if true;
      
      // Only authenticated admins can create, update, or delete products
      allow create: if isAdmin()
                    && request.resource.data.name is string
                    && request.resource.data.price is number
                    && request.resource.data.price >= 0;
      
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // Orders collection
    match /orders/{orderId} {
      // Anyone can read orders (for now - you may want to restrict this)
      allow read: if true;
      
      // Anyone can create orders (for checkout)
      allow create: if request.resource.data.keys().hasAll(['customer', 'items', 'total'])
                    && request.resource.data.customer.keys().hasAll(['name', 'email', 'phone'])
                    && request.resource.data.items is list
                    && request.resource.data.total is number
                    && request.resource.data.total >= 0;
      
      // Only authenticated admins can update orders
      allow update: if isAdmin();
      
      // Only authenticated admins can delete orders
      allow delete: if isAdmin();
    }
    
    // Settings collection (for shipping fees, etc.)
    match /settings/{settingId} {
      // Anyone can read settings (needed for checkout page)
      allow read: if true;
      
      // Only authenticated admins can write settings
      allow write: if isAdmin();
    }
    
    // Admin users collection (optional - for tracking admin users in Firestore)
    match /adminUsers/{userId} {
      // Only authenticated admins can read admin users list
      allow read: if isAdmin();
      
      // Only authenticated admins can create/update/delete admin users
      allow write: if isAdmin();
    }
    
    // Contact messages collection
    match /contactMessages/{messageId} {
      // Anyone can create contact messages (for contact form)
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'subject', 'message'])
                    && request.resource.data.name is string
                    && request.resource.data.email is string
                    && request.resource.data.subject is string
                    && request.resource.data.message is string;
      
      // Only authenticated admins can read, update, or delete messages
      allow read, update, delete: if isAdmin();
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      // Anyone can read reviews (public)
      allow read: if true;
      
      // Only authenticated users can create reviews
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasAll(['productId', 'userId', 'userName', 'userEmail', 'rating', 'comment'])
                    && request.resource.data.productId is string
                    && request.resource.data.userId is string
                    && request.resource.data.rating is number
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5
                    && request.resource.data.comment is string
                    && request.resource.data.comment.size() >= 10;
      
      // Only the review author can update their own review
      allow update: if isAuthenticated() 
                    && request.auth.uid == resource.data.userId;
      
      // Only the review author or admins can delete reviews
      allow delete: if isAuthenticated() 
                    && (request.auth.uid == resource.data.userId || isAdmin());
    }
  }
}
